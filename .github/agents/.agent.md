# Agent Specification: RylanLabs Universal

**Guardian**: Carter | **Ministry**: Identity | **Maturity**: v1.1.0

This document defines universal rules for AI-assisted code generation in RylanLabs repositories. Use this specification to enable proactive compliance instead of reactive remediation.

---

## Voice and Tone

- **Professional**: Technical language appropriate for production systems
- **Concise**: Minimal verbosity; every line carries meaning
- **Tech-Savvy**: Assume familiarity with Unix/Linux, Git, Docker, CI/CD
- **Esoteric Academic Slant**: Reference underlying principles (idempotency, referential transparency, audit trails)
- **Anti-Pattern**: Avoid marketing speak, hand-waving, or oversimplification

**Example Phrasing**:

- ✅ "Implement trap handlers for EXIT and ERR signals to ensure cleanup operations complete regardless of exit path"
- ❌ "Use traps to clean up files"

---

## Linting Standards

### Markdown (MD040, MD013, MD031, MD032, MD060)

**MD040 - Code Fence Language Specification**

- **Requirement**: All code fences MUST specify a language identifier
- **Supported**: `bash`, `python`, `yaml`, `json`, `text`, `markdown`, `shell`
- **Detection Logic**:
  - `$`, `cd`, `git` → `bash`
  - `def`, `import`, `class` → `python`
  - `name:`, `hosts:`, `tasks:` → `yaml`
  - `{`, `[` → `json`
  - `|`, `---`, `>` (YAML tables) → `markdown`
  - Terminal output, errors → `text`

**Example**:

```bash
# ✅ CORRECT
echo "Hello"

# ❌ INCORRECT
echo "Hello"
```

**MD013 - Line Length**

- **Limit**: 160 characters for markdown
- **Exception**: Code examples may exceed if functionally necessary
- **Rationale**: Balance readability with technical documentation verbosity

**MD031/MD032 - Blank Lines Around Fences and Lists**

- **Requirement**: One blank line before opening fence, one after closing fence
- **Requirement**: One blank line before list, one after list

**MD060 - Table Spacing**

- **Requirement**: Spaces around pipes: `| Header |` not `|Header|`
- **Separator Row**: `| --- |` (spaces around dashes)

---

### Python (Type Hints, Docstrings, Bandit, Ruff)

**Type Hints (mypy --strict)**

- **Requirement**: All functions MUST have type hints for parameters and return type
- **Coverage**: 100% of public functions and methods
- **Generics**: Use `ParamSpec`, `TypeVar` for flexible signatures
- **No**: `Any` type without explicit justification

**Example**:

```python
# ✅ CORRECT
def process_records(records: list[dict[str, Any]]) -> int:
    """Process records and return count."""
    return len(records)

# ❌ INCORRECT
def process_records(records):
    return len(records)
```

**Docstrings (Google Style)**

- **Format**: Google-style docstrings for all public functions/classes
- **Sections**: `Args:`, `Returns:`, `Raises:`, `Examples:`, `Note:`
- **Length**: Minimum 1 line; complex functions need detailed descriptions

**Example**:

```python
# ✅ CORRECT
def validate_schema(data: dict) -> bool:
    """Validate data against canonical schema.

    Args:
        data: Dictionary to validate against device manifest schema.

    Returns:
        True if valid, False otherwise.

    Raises:
        ValueError: If schema file not found.
    """
    pass
```

**Bandit (Security Scanning)**

- **S603/S607**: Subprocess with shell - use `shell=False` and pass list arguments
- **S602**: Shell with `sh -c` - only when necessary; document override
- **S101**: Assert statements - allowed in tests only

**Example**:

```python
# ✅ CORRECT
result = subprocess.run(['echo', 'hello'], capture_output=True)

# ❌ INCORRECT
result = subprocess.run('echo hello', shell=True)
```

**Ruff (Comprehensive Linting)**

- **D2xx**: Docstring issues (D200-D213 all required)
- **E**: PEP 8 errors
- **W**: PEP 8 warnings
- **F**: PyFlakes
- **I**: isort (import sorting)
- **B**: flake8-bugbear
- **RUF100**: Unused noqa comments must be removed

---

### Bash (ShellCheck, Traps, Quoting)

**Header Template**:

```bash
#!/usr/bin/env bash
# Guardian: Carter
# Ministry: Identity
# Maturity: v1.1.0
# Tag: descriptive-tag
```

**Set Options**:

- **Requirement**: `set -euo pipefail` (all Tier 0-1 scripts)
- **Meaning**:
  - `-e`: Exit on any error
  - `-u`: Fail on undefined variable
  - `-o pipefail`: Pipeline fails if any command fails

**Example**:

```bash
#!/usr/bin/env bash
set -euo pipefail

# ✅ Safe execution
echo "Starting..."
```

**Trap Handlers (Cleanup)**

- **EXIT**: Always runs; cleanup operations
- **ERR**: Runs on error; can log context
- **Requirement**: All shell scripts must implement trap handlers

**Example**:

```bash
trap 'log_error "Unexpected exit at line $LINENO"' ERR
trap 'cleanup_temp_files' EXIT
```

**Quoting (SC2086)**

- **Requirement**: All variable expansions MUST be quoted: `"$var"` not `$var`
- **Exception**: Explicit word-splitting contexts (documented)
- **Arrays**: Use `"${array[@]}"` for expansion

**Example**:

```bash
# ✅ CORRECT
echo "$filename"

# ❌ INCORRECT
echo $filename  # SC2086 violation
```

**Function Guidelines**:

- **Max Length**: 120 lines per function
- **Responsibility**: Single purpose per function
- **Exit Codes**: 0=success, 1=general error, 2+=specific failures
- **Error Messages**: Include function name and context

---

### YAML (yamllint, Line Length, Indentation)

**Line Length**:

- **Playbooks**: 140 characters max
- **Configs**: 120 characters max
- **Rationale**: Infrastructure-as-code often has long values

**Indentation**:

- **Standard**: 2 spaces (no tabs)
- **Consistency**: All levels must align

**Quotes**:

- **Requirement**: Strings with special chars must be quoted
- **Booleans**: Use `true`/`false` (not `yes`/`no`)
- **Numbers**: Quote numeric strings: `"12345"` not `12345`

**Example**:

```yaml
# ✅ CORRECT
servers:
  - name: "prod-server-01"
    enabled: true
    port: "8080"

# ❌ INCORRECT
servers:
  - name: prod-server-01
    enabled: yes
    port: 8080
```

---

## Seven Pillars Compliance

### 1. Idempotency

**Definition**: Running the same operation multiple times produces the same result; no side effects accumulate.

**Implementation**:

- Check state before making changes
- Use `set -i` for `rm`, `mv` operations (interactive prompt)
- Document idempotency assumptions

**Example**:

```bash
# ✅ CORRECT - Idempotent
if [[ ! -L "$symlink_path" ]]; then
    ln -s "$target" "$symlink_path"
fi

# ❌ INCORRECT - Not idempotent
ln -s "$target" "$symlink_path"  # Fails if symlink exists
```

### 2. Error Handling

**Definition**: Failures are detected, logged, and handled gracefully.

**Implementation**:

- Explicit error checks on critical operations
- Descriptive error messages with context
- Specific exception types (no bare `except:`)

**Example**:

```python
# ✅ CORRECT
try:
    with open(config_file) as f:
        data = json.load(f)
except FileNotFoundError as e:
    logger.error(f"Config not found: {config_file}")
    sys.exit(1)
except json.JSONDecodeError as e:
    logger.error(f"Invalid JSON in {config_file}: {e}")
    sys.exit(1)
```

### 3. Functionality

**Definition**: Code does what it claims; behavior matches documentation.

**Implementation**:

- Match implementation to docstring
- Add tests for critical paths
- Validate against schemas

---

### 4. Audit Logging

**Definition**: Actions are recorded for debugging and compliance.

**Implementation**:

- Log significant state changes
- Include timestamps, function names, context
- Structure logs for machine parsing (JSON, NDJSON)

**Example**:

```bash
log_info() {
    local msg="$1"
    echo "{\"timestamp\": \"$(date -Iseconds)\", \"level\": \"INFO\", \"message\": \"$msg\"}" >&2
}
```

### 5. Failure Recovery

**Definition**: System can recover from transient failures; no permanent data loss on error.

**Implementation**:

- Backup before mutation
- Version control for rollback
- Cleanup temp files on failure

---

### 6. Security Hardening

**Definition**: Code resists attacks; no secrets are exposed.

**Implementation**:

- No hardcoded credentials
- Input validation
- Minimal privilege elevation
- Security scanning (Bandit, shellcheck)

---

### 7. Documentation

**Definition**: Code is understandable; maintainers know intent and constraints.

**Implementation**:

- Docstrings for all public interfaces
- Inline comments for complex logic
- README with setup/usage examples
- Changelog with version history

---

## Trinity Pattern Integration

### Carter (Identity/Standards)

**Responsibility**: Enforce coding standards and architectural patterns.

**In Agent Specs**:

- Define what compliant code looks like
- Provide examples of correct patterns
- Document tool configurations

**When to Reference**: "This adheres to Carter's standards for..."

---

### Bauer (Audit)

**Responsibility**: Validate code against standards; detect violations.

**In Agent Specs**:

- Specify linting tools and configurations
- Define validation commands
- Document success criteria

**When to Reference**: "Bauer validates this with..."

---

### Beale (Security)

**Responsibility**: Harden code; mitigate security risks.

**In Agent Specs**:

- Specify security scanning tools (Bandit, ShellCheck)
- Document anti-patterns to avoid
- Reference CVE/CWE where applicable

**When to Reference**: "Beale requires this for..."

---

## Commit Message Format

**Template**:

```
<type>(<scope>): <subject>

<body>

Guardian: <Carter|Bauer|Beale> | Maturity: v<X.Y.Z>
Compliance: <compliance-status>
```

**Types**:

- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation
- `style`: Formatting (no logic change)
- `refactor`: Code restructuring
- `test`: Test additions/fixes
- `chore`: Build, deps, tooling
- `ci`: CI/CD pipeline changes

**Example**:

```
feat(agents): implement agentic foundation v1.1.0

- Created .agent.md with universal rules
- Added language overlays (Python, Bash, Markdown, YAML)
- Integrated with GitHub Copilot via agentSpecificationPath

Guardian: Carter | Maturity: v1.1.0
Compliance: Seven Pillars ✓ | Trinity ✓ | Hellodeolu v6 ✓
```

---

## Prohibited Patterns

### ❌ No `git commit --no-verify`

**Reason**: Bypasses pre-commit hooks; allows non-compliant code into repository.

**Correct Alternative**:

```bash
# Fix violations first
pre-commit run --all-files

# Then commit normally
git commit -m "fix: resolve linting violations"
```

---

### ❌ No Hardcoded Secrets

**Includes**: Passwords, API keys, tokens, private IPs.

**Detection**: Use `git-secrets` or `detect-secrets` in pre-commit.

**Correct Alternative**:

```python
# Use environment variables
api_key = os.environ.get('API_KEY')
if not api_key:
    raise ValueError("API_KEY environment variable not set")
```

---

### ❌ No `rm -rf` Without Confirmation

**Reason**: Irreversible data loss if path is wrong.

**Correct Alternative**:

```bash
# Interactive prompt
rm -ri "$directory"

# Or explicit confirmation
if [[ "${FORCE_DELETE:-false}" == "true" ]]; then
    rm -rf "$directory"
else
    echo "Would delete: $directory"
    echo "Run with FORCE_DELETE=true to confirm"
fi
```

---

### ❌ No "Consciousness" Counters

**Reason**: Terminology bleed from previous repository; non-educational tone.

**Correct Alternative**: Use `Maturity: vX.Y.Z`

```yaml
# ❌ INCORRECT
consciousness: 9.9

# ✅ CORRECT
maturity: v1.1.0
```

---

## Tool References

### Pre-commit

- **Location**: `.pre-commit-config.yaml`
- **Usage**: `pre-commit run --all-files`
- **Config**: Controls which hooks execute for which files

### markdownlint

- **Config**: `.markdownlint.yaml`
- **Line Limit**: 160 characters
- **Command**: `markdownlint docs/` or `make ci-local`

### ShellCheck

- **Command**: `shellcheck scripts/*.sh`
- **Config**: `.shellcheckrc` (if exists)

### mypy

- **Mode**: `--strict` (required for Tier 0-1)
- **Command**: `mypy --strict linting/`

### Ruff

- **Line Length**: 120 characters for code
- **Command**: `ruff check . --fix` (auto-fix mode)

### yamllint

- **Line Length**: 140 (playbooks), 120 (configs)
- **Command**: `yamllint -c .yamllint pre-commit/`

---

## Validation Commands

### Full Local Validation

```bash
# Run all checks (if Makefile exists)
make ci-local

# Or manually:
pre-commit run --all-files
markdownlint docs/ agents/ instructions/
shellcheck scripts/*.sh
```

### By Language

**Python**:

```bash
mypy --strict linting/
ruff check linting/ --fix
```

**Bash**:

```bash
shellcheck scripts/*.sh
```

**Markdown**:

```bash
markdownlint docs/ agents/ instructions/
```

**YAML**:

```bash
yamllint -c .yamllint pre-commit/
```

---

## Override Protocol

**When to Override**: In rare cases where standards conflict with legacy requirements or platform constraints.

**Syntax in Code**:

```python
# agent-override: Legacy API pattern required for backward compatibility with v0.9.0
def non_compliant_function():  # noqa: D103
    pass
```

```bash
# agent-override: Requires shell=True due to complex globbing in production systems
result = subprocess.run(pattern_cmd, shell=True)  # noqa: S602
```

**Requirements**:

1. Document reason in comment
2. Include reference (PR, issue, ticket)
3. Link to noqa/ignore directive if applicable
4. Plan removal date (e.g., "Remove when v2.0.0 released")

**Process for Permanent Changes**:

1. File issue with override examples
2. Discuss with team (Guardian: Carter)
3. Update `.agent.md` with new guidance
4. Remove override comments in subsequent refactor

---

## Update History

- **v1.1.0** (2025-12-31): Initial agentic foundation
  - Universal rules, Trinity integration, Seven Pillars compliance
  - Language overlays for Python, Bash, Markdown, YAML
  - Commit format standardization
  - Override protocol documented

---

**Guardian**: Carter | **Ministry**: Identity | **Maturity**: v1.1.0
